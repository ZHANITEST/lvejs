/* Linoaca Visualnovel Engine
 * version 1.0.1
 * Made by izure | "LVE.js (C) izure 2016. All rights reserved."
 * http://linoaca.com, http://blog.linoaca.com
 *
 * How to use?
 * → http://blog.linoaca.com
 */

var lve=function(name){var retArray=[];if(typeof name=="string"){switch(name){case"*":retArray=lve_root.vars.arr_object;break;case"[USING_SCENE]":retArray=lve_root.vars.arr_scene[lve_root.vars.usingCamera.scene];break;case"[USING_CAMERA]":retArray=[lve_root.vars.usingCamera];break;default:retArray=lve_root.vars.selectorKeyword[name];break}return new lve.fn.session(name,retArray)}else{if(name.context)return new lve.fn.session(name.name,name.context);else return new lve.fn.session(name.name,[name])}},lve_root={vars:{isStart:!1,isNeedSort:!1,primary:1,arr_object:[],arr_scene:{},arr_callback:[],arr_type:["camera","image","circle","square","text"],arr_event:["animatestart","animateend","animatestop","moved"],initSetting:{},usingCamera:undefined,selectorKeyword:{}},fn:{update:function(progress){var canvasContext=lve_root.vars.initSetting.canvas.context,isNeedSort=Number(lve_root.vars.isNeedSort),isNeedDraw=!1,isDrawFrame=Math.floor(progress)%(60/lve_root.vars.initSetting.frameLimit)==0;if(isDrawFrame){canvasContext.fillStyle=lve_root.vars.initSetting.backgroundColor;canvasContext.fillRect(0,0,lve_root.vars.initSetting.canvas.width,lve_root.vars.initSetting.canvas.height)}for(var i in lve_root.vars.arr_object){if(!lve_root.vars.arr_object[i])continue;var item=lve_root.vars.arr_object[i],attr_translateend=0,attr_Length=item.ani_init.count_max?Object.keys(item.ani_init.count_max).length:0;if(item.scene!=lve_root.vars.usingCamera.scene)continue;if(!item.ani_init.count_max)continue;for(var j in item.style){if(item.ani_init[j]===undefined)continue;if(item.ani_init[j]!=item.ani_init.origin[j]&&item.ani_init.count[j]<item.ani_init.count_max[j]){isNeedDraw=!0;item.style[j]=item.getEasingData(j);item.ani_init.count[j]++}if(item.ani_init[j]!=item.ani_init.origin[j]&&item.ani_init.count[j]<item.ani_init.count_max[j])isNeedSort+=item.type!="camera"?1:0;if(item.ani_init.count[j]>=item.ani_init.count_max[j]){item.style[j]=item.ani_init[j]!==undefined?item.ani_init[j]:item.style[j];attr_translateend++;delete item.ani_init[j]}if(attr_translateend>=attr_Length)lve(item).stop().emit("animateend")}lve(item).emit("moved")}if(isDrawFrame){if(isNeedSort){lve_root.vars.isNeedSort=!1;lve_root.vars.arr_object.sort(function(a,b){return parseFloat(b.style.perspective)-parseFloat(a.style.perspective)})}for(var i in lve_root.vars.arr_object){var item=lve_root.vars.arr_object[i];if(item.scene==lve_root.vars.usingCamera.scene||item.scene=="anywhere")item.draw()}}for(var i in lve_root.vars.arr_callback){var item=lve_root.vars.arr_callback[i];if(item.count>0)item.count--else{item.fn();delete lve_root.vars.arr_callback[i]}}if(!!lve_root.vars.initSetting.userExtend&&typeof lve_root.vars.initSetting.userExtend=="function")lve.root_vars.initSetting.userExtend();window.requestAnimationFrame(lve_root.fn.update)},adjustJSON:function(data){for(var i in data){if(typeof data[i]!="object"){var data_origin=data[i];delete data[i];i=(i+"").replace(/-.|[A-Z](?=[a-z])/gm,function(v){return"["+v+"]"}).toLowerCase().replace(/\[.\]/gmi,function(v){return v.substr(1,1).toUpperCase()});data[i]=isNaN(parseFloat(data_origin))?data_origin:parseFloat(data_origin)}}return data},canvasReset:function(){lve_root.vars.initSetting.canvas.context.restore();lve_root.vars.initSetting.canvas.context.save();lve_root.vars.initSetting.canvas.context.beginPath()}}};lve.init=function(data){data=lve_root.fn.adjustJSON(data);var initSetting=lve_root.vars.initSetting;initSetting.scaleDistance=data.scaleDistance!==undefined?data.scaleDistance:initSetting.scaleDistance?initSetting.scaleDistance:150;initSetting.disappearanceSize=data.disappearanceSize!==undefined?data.disappearanceSize:initSetting.disappearanceSize?initSetting.disappearanceSize:undefined;initSetting.disappearanceSight=data.disappearanceSight!==undefined?data.disappearanceSight+initSetting.scaleDistance:undefined;initSetting.frameLimit=data.frameLimit!==undefined?data.frameLimit:initSetting.frameLimit?initSetting.frameLimit:60;initSetting.backgroundColor=data.backgroundColor!==undefined?data.backgroundColor:initSetting.backgroundColor?initSetting.backgroundColor:"white";initSetting.canvas=initSetting.canvas||{};initSetting.canvas.context=data.canvas!==undefined?data.canvas.getContext("2d"):initSetting.canvas.context?initSetting.canvas.context:undefined;initSetting.canvas.width=initSetting.canvas.context.canvas.width;initSetting.canvas.height=initSetting.canvas.context.canvas.height;lve_root.fn.canvasReset();initSetting.userExtend=data.extend;initSetting.success=!0;if(!lve_root.vars.isStart){lve_root.vars.isStart=!0;lve_root.fn.update(0)}return!0},lve.canvasResize=function(){lve_root.vars.initSetting.canvas.width=lve_root.vars.initSetting.canvas.context.canvas.width;lve_root.vars.initSetting.canvas.height=lve_root.vars.initSetting.canvas.context.canvas.height},lve.reltofix=function(p){var initSetting=lve_root.vars.initSetting,canvas=initSetting.canvas,left=(canvas.width/2)-p,bottom=(canvas.height/2)-p;return{left:left,bottom:bottom}},lve.fn={session:function(selector,context){this.name=selector;this.context=context}};lve.fn.session.prototype.getEasingData=function(attr){if(!this.ani_init.count_max||!attr)return!1;var tar=this.ani_init.origin[attr],tar_goal=this.ani_init[attr];if(tar===undefined||tar_goal===undefined)return!1;var t=this.ani_init.count[attr]*1000/60||1,b=tar,c=tar_goal-tar,d=this.ani_init.duration[attr]||1,easing=this.ani_init.easing[attr]||"linear";switch(easing){case"linear":return c*t/d+b;case"easeInQuad":t/=d;return c*t*t+b;case"easeOutQuad":t/=d;return-c*t*(t-2)+b;case"easeInOutQuad":t/=d/2;if(t<1)return c/2*t*t+b;t--;return-c/2*(t*(t-2)-1)+b;case"easeInCubic":t/=d;return c*t*t*t+b;case"easeOutCubic":t/=d;t--;return c*(t*t*t+1)+b;case"easeInOutCubic":t/=d/2;if(t<1)return c/2*t*t*t+b;t-=2;return c/2*(t*t*t+2)+b;case"easeInQuart":t/=d;return c*t*t*t*t+b;case"easeOutQuart":t/=d;t--;return-c*(t*t*t*t-1)+b;case"easeInOutQuart":t/=d/2;if(t<1)return c/2*t*t*t*t+b;t-=2;return-c/2*(t*t*t*t-2)+b;case"easeInQuint":t/=d;return c*t*t*t*t*t+b;case"easeOutQuint":t/=d;t--;return c*(t*t*t*t*t+1)+b;case"easeInOutQuint":t/=d/2;if(t<1)return c/2*t*t*t*t*t+b;t-=2;return c/2*(t*t*t*t*t+2)+b;case"easeInSine":return-c*Math.cos(t/d*(Math.PI/2))+c+b;case"easeOutSine":return c*Math.sin(t/d*(Math.PI/2))+b;case"easeInOutSine":return-c/2*(Math.cos(Math.PI*t/d)-1)+b;case"easeInExpo":return c*Math.pow(2,10*(t/d-1))+b;case"easeOutExpo":return c*(-Math.pow(2,-10*t/d)+1)+b;case"easeInOutExpo":t/=d/2;if(t<1)return c/2*Math.pow(2,10*(t-1))+b;t--;return c/2*(-Math.pow(2,-10*t)+2)+b;case"easeInCirc":t/=d;return-c*(Math.sqrt(1-t*t)-1)+b;case"easeOutCirc":t/=d;t--;return c*Math.sqrt(1-t*t)+b;case"easeInOutCirc":t/=d/2;if(t<1)return-c/2*(Math.sqrt(1-t*t)-1)+b;t-=2;return c/2*(Math.sqrt(1-t*t)+1)+b}};lve.fn.session.prototype.create=function(data){if(!data.type){console.error("type속성은 객체 필수 속성입니다. 다음 중 한 가지를 필수로 선택해주세요. ("+lve_root.vars.arr_type.join(", ")+")");return!1}else if(lve_root.vars.arr_type.indexOf(data.type.toLowerCase())==-1){console.error("존재하지 않는 type속성입니다. 이용할 수 있는 type속성은 다음과 같습니다. ("+lve_root.vars.arr_type.join(", ")+")");return!1}data=lve_root.fn.adjustJSON(data);this.primary=lve_root.vars.primary++;this.type=data.type.toLowerCase();this.scene=data.scene||"main";this.src=data.src;this.text=data.text;this.follow_init={follower:[],following:undefined,relative:{}};this.style={fontSize:10,fontFamily:'arial, sans-serif',fontWeight:"normal",fontStyle:"normal",textAlign:"left",width:this.type!="text"?10:"auto",height:10,color:"black",borderWidth:0,borderColor:"black",shadowColor:undefined,shadowBlur:10,shadowOffsetX:0,shadowOffsetY:0,position:"absolute",bottom:0,left:0,perspective:data.type=="camera"?0:lve_root.vars.initSetting.scaleDistance,};this.events={};for(var i in lve_root.vars.arr_event)this.events[lve_root.vars.arr_event[i]]=[];delete this.context;this.relative={};this.ani_init={};if(!lve_root.vars.arr_scene[this.scene])lve_root.vars.arr_scene[this.scene]=[];lve_root.vars.arr_object.push(this);lve_root.vars.arr_scene[this.scene].push(this);lve_root.vars.isNeedSort=!0;if(lve_root.vars.selectorKeyword[this.name]===undefined)lve_root.vars.selectorKeyword[this.name]=[];lve_root.vars.selectorKeyword[this.name].push(this);lve_root.vars.selectorKeyword["[PRIMARY="+this.primary+"]"]=[];lve_root.vars.selectorKeyword["[PRIMARY="+this.primary+"]"].push(this);return lve(this)};lve.fn.session.prototype.attr=function(data){if(!data)return!1;data=lve_root.fn.adjustJSON(data);for(var i in this.context){var item=this.context[i];for(var j in item)item[j]=data[j]||item[j]}return this};lve.fn.session.prototype.css=function(data){if(!data)return!1;data=lve_root.fn.adjustJSON(data);if(data.position!==undefined&&data.position!="absolute"&&data.position!="fixed"){console.error("position:"+data.position+"은 사용할 수 없는 속성입니다. 사용할 수 있는 속성은 다음과 같습니다. (absolute, fixed) 기본값은 absolute입니다.");return!1}for(var i in this.context){var item=this.context[i];for(var j in data)item.style[j]=data[j]!==undefined?data[j]:item.style[j];if(item.type=="text"&&item.style.width=="auto"){var canvas=lve_root.vars.initSetting.canvas;lve_root.fn.canvasReset();canvas.context.font=item.style.fontStyle+" "+item.style.fontWeight+" "+item.style.fontSize+"px "+item.style.fontFamily;canvas.context.fillStyle="transparent";item.style.width=canvas.context.measureText(item.text).width}lve(item).emit("moved")}return this};lve.fn.session.prototype.draw=function(){var canvas=lve_root.vars.initSetting.canvas,ctx=canvas.context,initSetting=lve_root.vars.initSetting;lve_root.fn.canvasReset();function _getRelativeSize(tarObject,cameraObject,tarObject_size){return tarObject_size*initSetting.scaleDistance/(tarObject.style.position=="absolute"?tarObject.style.perspective-lve_root.vars.usingCamera.style.perspective:tarObject.style.perspective)}function _getRelativePosition(tarObject,cameraObject,direction){var pt_center=direction=="left"?canvas.width/2:canvas.height/2,fix_measure=direction=="left"?tarObject.relative.width/2:tarObject.relative.height,relativeSize,m=direction=="left"?1:-1;relativeSize=tarObject.style.position=="absolute"?m*((tarObject.style[direction]-cameraObject.style[direction])*initSetting.scaleDistance/tarObject.relative.perspective):-tarObject.style[direction];return pt_center-fix_measure+relativeSize}if(!lve_root.vars.usingCamera)return!1;this.relative.perspective=this.style.perspective-lve_root.vars.usingCamera.style.perspective;this.relative.fontSize=_getRelativeSize(this,lve_root.vars.usingCamera,this.style.fontSize);this.relative.borderWidth=_getRelativeSize(this,lve_root.vars.usingCamera,this.style.borderWidth);this.relative.width=_getRelativeSize(this,lve_root.vars.usingCamera,this.style.width);this.relative.height=_getRelativeSize(this,lve_root.vars.usingCamera,this.style.height||1);this.relative.left=_getRelativePosition(this,lve_root.vars.usingCamera,"left");this.relative.bottom=_getRelativePosition(this,lve_root.vars.usingCamera,"bottom");if(this.type=="camera"||this.type=="image"&&!this.src||this.type!="image"&&!this.style.color||this.type=="text"&&!this.text||this.type=="text"&&!this.style.fontSize||this.relative.width<=0||this.relative.height<=0||this.relative.left+this.relative.width<0||this.relative.left-this.relative.width>canvas.width||this.relative.bottom+this.relative.height<0||this.relative.bottom-this.relative.height>canvas.height||this.relative.width<initSetting.disappearanceSize||this.relative.height<initSetting.disappearanceSize||initSetting.disappearanceSight!==undefined&&this.relative.perspective>initSetting.disappearanceSight)return!1;switch(this.type){case"image":var imageObj=new Image();imageObj.src=this.src;ctx.drawImage(imageObj,this.relative.left,this.relative.bottom,this.relative.width,this.relative.height);break;case"circle":canvas.context.fillStyle=this.style.color;if(ctx.shadowColor){ctx.shadowColor=this.style.shadowColor;ctx.shadowBlur=this.style.shadowBlur;ctx.shadowBlur=this.style.shadowBlur;ctx.shadowOffsetX=this.style.shadowOffsetX;ctx.shadowOffsetY=this.style.shadowOffsetY}ctx.arc(this.relative.left+this.relative.width/2,this.relative.bottom+this.relative.width/2,this.relative.width/2,0,Math.PI*2);ctx.fill();lve_root.fn.canvasReset();ctx.arc(this.relative.left+this.relative.width/2,this.relative.bottom+this.relative.width/2,this.relative.width/2+this.relative.borderWidth/2,0,Math.PI*2);ctx.strokeStyle=this.style.borderColor;ctx.lineWidth=this.relative.borderWidth;if(this.style.borderWidth)ctx.stroke();break;case"square":canvas.context.fillStyle=this.style.color;if(ctx.shadowColor){ctx.shadowColor=this.style.shadowColor;ctx.shadowBlur=this.style.shadowBlur;ctx.shadowOffsetX=this.style.shadowOffsetX;ctx.shadowOffsetY=this.style.shadowOffsetY}ctx.rect(this.relative.left,this.relative.bottom,this.relative.width,this.relative.height);ctx.fill();lve_root.fn.canvasReset();ctx.rect(this.relative.left-this.relative.borderWidth/2,this.relative.bottom-this.relative.borderWidth/2,this.relative.width+this.relative.borderWidth,this.relative.height+this.relative.borderWidth);ctx.strokeStyle=this.style.borderColor;ctx.lineWidth=this.relative.borderWidth;if(this.style.borderWidth)ctx.stroke();break;case"text":var fix_textAlignLeft=this.relative.width/2;ctx.font=this.style.fontStyle+" "+this.style.fontWeight+" "+this.relative.fontSize+"px "+this.style.fontFamily;ctx.fillStyle=this.style.color;ctx.textAlign=this.style.textAlign;if(ctx.shadowColor){ctx.shadowColor=this.style.shadowColor;ctx.shadowBlur=this.style.shadowBlur;ctx.shadowOffsetX=this.style.shadowOffsetX;ctx.shadowOffsetY=this.style.shadowOffsetY}ctx.strokeStyle=this.style.borderColor;ctx.lineWidth=this.relative.borderWidth;if(this.style.borderWidth)ctx.strokeText(this.text,this.relative.left+fix_textAlignLeft,this.relative.bottom,this.relative.width);ctx.fillText(this.text,this.relative.left+fix_textAlignLeft,this.relative.bottom,this.relative.width);break}};lve.fn.session.prototype.use=function(){lve_root.vars.usingCamera=Array.isArray(this.context)?this.context[0]:this.context;return lve(lve_root.vars.usingCamera)};lve.fn.session.prototype.follow=function(tarObjectName,relativePosition){var tarObject=lve(tarObjectName),relativePosition=relativePosition||{};if(!tarObject.context.length)return!1;tarObject=tarObject.context[0];lve(this).unfollow();for(var i in this.context){var item=this.context[i],arr_follower=[];item.follow_init.following=tarObject;item.follow_init.relative={bottom:relativePosition.bottom||0,left:relativePosition.left||0,perspective:relativePosition.perspective||0};if(tarObject.follow_init.follower.indexOf(item)==-1){tarObject.follow_init.follower.push(item);lve(tarObject).on("moved",function(e){for(var j in e.target.follow_init.follower){var follower=e.target.follow_init.follower[j],obj_follower=follower.follow_init.relative;lve(follower).css({left:tarObject.style.left+obj_follower.left,bottom:tarObject.style.bottom+obj_follower.bottom,perspective:tarObject.style.perspective+obj_follower.perspective})}})}}return this};lve.fn.session.prototype.unfollow=function(){for(var i in this.context){if(!this.context[i].follow_init.following)return!1;var item=this.context[i],item_following=item.follow_init.following,item_follower=item_following.follow_init.follower,arr_follower=[];lve(item_following).off("moved");item.follow_init.following=undefined;for(var j in item_follower){if(item_follower[j]==item)item_follower[j]=undefined;else arr_follower.push(item_follower[j])}item_following.follow_init.follower=arr_follower}return this};lve.fn.session.prototype.kick=function(tarObjectName){var arr_kickTar=lve(tarObjectName).context;for(var i in this.context){var item=this.context[i],item_follower=item.follow_init.follower;for(var j in item_follower)if(arr_kickTar.indexOf(item_follower[j])!=-1)lve(item_follower[j]).unfollow()}return this};lve.fn.session.prototype.animate=function(data,duration,easing,callback){if(!data)return!1;data=lve_root.fn.adjustJSON(data);duration=duration||1;easing=easing||"linear";for(var i in this.context){var item=this.context[i];item.ani_init.count=item.ani_init.count||{};item.ani_init.count_max=item.ani_init.count_max||{};item.ani_init.duration=item.ani_init.duration||{};item.ani_init.easing=item.ani_init.easing||{};item.ani_init.origin=item.ani_init.origin||{};for(var j in data){if(isNaN(parseFloat(data[j])))continue;if(data[j]!==undefined&&data[j]!==item.style[j]){item.ani_init.duration[j]=duration;item.ani_init[j]=data[j];item.ani_init.origin[j]=item.style[j];item.ani_init.count[j]=0;item.ani_init.count_max[j]=Math.ceil(item.ani_init.duration[j]/1000*60);item.ani_init.easing[j]=easing}}lve("[PRIMARY="+item.primary+"]").emit("animatestart")}for(var i in arguments){if(typeof arguments[i]!="function")continue;lve_root.vars.arr_callback.push({count:Math.ceil(item.ani_init.duration[j]/1000*60),fn:arguments[i]});break}return this};lve.fn.session.prototype.stop=function(){for(var i in this.context){this.context[i].ani_init={};lve("[PRIMARY="+this.context[i].primary+"]").emit("animatestop")}return this};lve.fn.session.prototype.remove=function(){var arr_object=lve_root.vars.arr_object,arr_scene=lve_root.vars.arr_scene,usingScene=lve_root.vars.usingCamera?lve_root.vars.usingCamera.scene:"main";for(var i in this.context){var item=this.context[i],arr_newObject_object=[],arr_newObject_scene=[];for(var j in arr_object)if(arr_object[j].primary==item.primary)delete lve_root.vars.selectorKeyword["[PRIMARY="+item.primary+"]"];else arr_newObject_object.push(arr_object[j]);lve_root.vars.arr_object=arr_newObject_object;for(var j in arr_scene){var arr_scene_item=arr_scene[j];if(j!=item.scene)continue;for(var k in arr_scene_item)if(arr_scene_item[k].primary!=item.primary)arr_newObject_scene.push(arr_scene_item[k]);lve_root.vars.arr_scene[arr_scene_item[k].scene]=arr_newObject_scene}}};lve.fn.session.prototype.on=function(e,fn){if(e===undefined){console.error("이벤트리스너가 없습니다. 다음 중 한 가지를 필수로 선택해주세요. ("+lve_root.vars.arr_event.join(", ")+")");return!1}if(!fn)return!1;e=e.split(" ");for(var i in e){var item=e[i];if(lve_root.vars.arr_event.indexOf(item.toLowerCase())==-1){console.error("존재하지 않는 이벤트입니다. 이용할 수 있는 이벤트는 다음과 같습니다. ("+lve_root.vars.arr_event.join(", ")+")");return!1}for(var j in this.context)this.context[j].events[item].push(fn)}return fn};lve.fn.session.prototype.off=function(e){if(e===undefined){console.error("이벤트리스너가 없습니다. 다음 중 한 가지를 필수로 선택해주세요. ("+lve_root.vars.arr_event.join(", ")+")");return!1}e=e.split(" ");for(var i in e){var item=e[i];if(lve_root.vars.arr_event.indexOf(item.toLowerCase())==-1){console.error("존재하지 않는 이벤트입니다. 이용할 수 있는 이벤트는 다음과 같습니다. ("+lve_root.vars.arr_event.join(", ")+")");return!1}for(var j in this.context)this.context[j].events[item]=[]}return!0};lve.fn.session.prototype.emit=function(e){for(var i in this.context){var item=this.context[i],eObj={type:e,target:item};for(var j in item.events[e])item.events[e][j](eObj)}};